---
name: Deploy to Environment
on:
  push:
    branches: [qa, prod]
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options: [qa, prod]
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/prod' && 'prod' || 'qa') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/prod" ]; then
            ENV="prod"
          else
            ENV="qa"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "::notice::Deploying to $ENV environment"
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets[format('SSH_PRIVATE_KEY_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets[format('SSH_HOST_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }} >> ~/.ssh/known_hosts
      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets[format('SSH_HOST_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          SSH_USER: ${{ secrets[format('SSH_USER_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          ENV_NAME: ${{ steps.env.outputs.environment }}
        run: |
          # Create environment-specific .env file
          cat > .env.deploy << EOF
          # Database
          IDHUB_DB_NAME=${{ secrets[format('DB_NAME_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          IDHUB_DB_USER=${{ secrets[format('DB_USER_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          IDHUB_DB_PASSWORD=${{ secrets[format('DB_PASSWORD_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}

          # GSID Service
          GSID_API_KEY=${{ secrets[format('GSID_API_KEY_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}

          # REDCap
          REDCAP_API_TOKEN_CD_ILEAL=${{ secrets[format('REDCAP_API_TOKEN_CD_ILEAL_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          REDCAP_API_TOKEN_GAP=${{ secrets[format('REDCAP_API_TOKEN_GAP_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          REDCAP_API_TOKEN_UC_DEMARC=${{ secrets[format('REDCAP_API_TOKEN_UC_DEMARC_{0}', steps.env.outputs.environment == 'prod' && 'PROD' || 'QA')] }}
          EOF

          # Copy .env file to server
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no .env.deploy ${SSH_USER}@${SSH_HOST}:/opt/idhub/.env

          # Remove local copy
          rm .env.deploy
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            echo "=== Starting deployment to ${{ steps.env.outputs.environment }} ==="

            # Navigate to project directory
            cd /opt/idhub

            # Verify .env file exists
            if [ ! -f .env ]; then
              echo "ERROR: .env file not found"
              exit 1
            fi

            # Backup current state
            echo "Creating backup..."
            BACKUP_DIR="/opt/idhub/backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            docker-compose config > "$BACKUP_DIR/docker-compose.backup.yml"
            cp .env "$BACKUP_DIR/.env.backup"

            # Pull latest code
            echo "Pulling latest code from ${{ github.ref_name }}..."
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Stop services gracefully
            echo "Stopping services..."
            docker-compose down --timeout 30

            # Prune old images to save space
            echo "Cleaning up old Docker images..."
            docker image prune -f --filter "until=168h"

            # Build services
            echo "Building services..."
            docker-compose build gsid-service redcap-pipeline fragment-validator table-loader

            # Start services
            echo "Starting services..."
            docker-compose up -d

            # Wait for health checks
            echo "Waiting for services to be healthy..."
            sleep 10

            # Verify services are running
            echo "Verifying deployment..."
            docker-compose ps

            # Check GSID service health
            for i in {1..30}; do
              if docker-compose exec -T gsid-service wget -q -O - http://localhost:8000/health > /dev/null 2>&1; then
                echo "✓ GSID service is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "✗ GSID service health check failed"
                docker-compose logs --tail=50 gsid-service
                exit 1
              fi
              sleep 2
            done
            echo "=== Deployment completed successfully ==="
          ENDSSH
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      - name: Deployment summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      - name: Deployment failure notification
        if: failure()
        run: |-
          echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
