name: Backup Prod DB
on:
  schedule:
    - cron: '0 4 * * *' # 12 AM ET / 4 AM UTC
  workflow_dispatch:

jobs:
  backup-prod:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST_PROD }} >> ~/.ssh/known_hosts

      - name: Perform Backup on Prod
        env:
          SSH_HOST: ${{ secrets.SSH_HOST_PROD }}
          SSH_USER: ${{ secrets.SSH_USER_PROD }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            echo "=== Starting Database Backup on Prod ==="
            cd /opt/idhub
            
            # Verify .env exists and load it
            if [ ! -f .env ]; then
              echo "ERROR: .env file not found"
              exit 1
            fi
            export $(grep -v '^#' .env | xargs)
            
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="prod_backup_${TIMESTAMP}.sql.gz"
            S3_PATH="s3://idhub-backup/prod/${BACKUP_FILE}"
            
            echo "1. Creating DB dump..."
            # Use docker-compose to exec pg_dump inside the container
            # PGPASSWORD is passed via env to avoid interactive prompt
            docker-compose exec -T -e PGPASSWORD=$DB_PASSWORD idhub_db \
              pg_dump -U idhub_user -h localhost idhub | gzip > "${BACKUP_FILE}"
            
            echo "2. Uploading to S3 (${S3_PATH})..."
            # Use a temporary aws-cli container to upload, mounting the current directory
            docker run --rm -v "$(pwd):/data" \
              -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID 
              -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY 
              -e AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION 
              amazon/aws-cli s3 cp "/data/${BACKUP_FILE}" "${S3_PATH}"
            
            echo "3. Cleaning up local backup file..."
            rm "${BACKUP_FILE}"
            
            echo "=== Backup Completed Successfully ==="
          ENDSSH

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
