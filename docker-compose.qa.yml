---
# docker-compose.qa.yml
# QA environment stack
services:
  nginx-qa:
    image: nginx:alpine
    container_name: nginx_qa
    restart: unless-stopped
    ports:
      - 8080:80  # Different ports if on same server
      - 8443:443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/gsid-api-qa.conf:/etc/nginx/conf.d/gsid-api-qa.conf:ro
      - ./nginx/conf.d/nocodb-qa.conf:/etc/nginx/conf.d/nocodb-qa.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on: [nocodb-qa, gsid-service-qa]
    networks: [idhub_network_qa]
  nocodb-qa:
    image: nocodb/nocodb:latest
    container_name: nocodb_qa
    restart: unless-stopped
    expose: ['8081']
    environment:
      NC_DB: pg://nocodb_db_qa:5432?u=nocodb&p=${NOCODB_DB_PASSWORD_QA}&d=nocodb
      NC_AUTH_JWT_SECRET: ${JWT_SECRET_QA}
      NC_PUBLIC_URL: https://qa.idhub.ibdgc.org
      NC_DISABLE_TELE: 'true'
      # QA-specific settings
      NC_ENV: qa
    volumes: [nocodb_data_qa:/usr/app/data]
    depends_on:
      nocodb_db_qa:
        condition: service_healthy
    networks: [idhub_network_qa]
    healthcheck:
      test:
        - CMD
        - wget
        - -q
        - -O
        - '-'
        - http://localhost:8081/api/v1/health
      interval: 30s
      timeout: 10s
      retries: 3
  nocodb_db_qa:
    image: postgres:15-alpine
    container_name: nocodb_db_qa
    restart: unless-stopped
    environment:
      POSTGRES_DB: nocodb
      POSTGRES_USER: nocodb
      POSTGRES_PASSWORD: ${NOCODB_DB_PASSWORD_QA}
      POSTGRES_INITDB_ARGS: -E UTF8
    volumes: [nocodb_db_data_qa:/var/lib/postgresql/data]
    networks: [idhub_network_qa]
    healthcheck:
      test: [CMD-SHELL, pg_isready -U nocodb]
      interval: 10s
      timeout: 5s
      retries: 5
  idhub_db_qa:
    image: postgres:15-alpine
    container_name: idhub_db_qa
    restart: unless-stopped
    ports:
      - 127.0.0.1:5433:5432  # Different port for QA
    command: postgres -c listen_addresses='*'
    environment:
      POSTGRES_DB: idhub_qa
      POSTGRES_USER: idhub_user_qa
      POSTGRES_PASSWORD: ${IDHUB_DB_PASSWORD_QA}
      POSTGRES_INITDB_ARGS: -E UTF8
    volumes:
      - idhub_db_data_qa:/var/lib/postgresql/data
      - ./database/init-scripts:/docker-entrypoint-initdb.d:ro
    networks: [idhub_network_qa]
    healthcheck:
      test: [CMD-SHELL, pg_isready -U idhub_user_qa -d idhub_qa]
      interval: 10s
      timeout: 5s
      retries: 5
  gsid-service-qa:
    build: ./gsid-service
    container_name: gsid_service_qa
    restart: unless-stopped
    expose: ['8001']
    environment:
      DB_HOST: idhub_db_qa
      DB_NAME: idhub_qa
      DB_USER: idhub_user_qa
      DB_PASSWORD: ${IDHUB_DB_PASSWORD_QA}
      GSID_API_KEY: ${GSID_API_KEY_QA}
      DB_PORT: 5432
      ENVIRONMENT: qa
    depends_on:
      idhub_db_qa:
        condition: service_healthy
    networks: [idhub_network_qa]
    healthcheck:
      test: [CMD, wget, -q, -O, '-', http://localhost:8001/health]
      interval: 30s
      timeout: 10s
      retries: 3
volumes:
  nocodb_data_qa:
    driver: local
  nocodb_db_data_qa:
    driver: local
  idhub_db_data_qa:
    driver: local
networks:
  idhub_network_qa:
    driver: bridge
